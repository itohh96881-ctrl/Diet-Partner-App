<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diet Partner App (Cloud Sync)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Import Maps for React & Icons -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1"
        }
    }
    </script>
    <style>
        /* 画像生成中のきらめきアニメーション */
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        .animate-shimmer {
            animation: shimmer 2s infinite linear;
            background: linear-gradient(to right, #f1f5f9 4%, #e2e8f0 25%, #f1f5f9 36%);
            background-size: 1000px 100%;
        }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="module">
        // Firebase SDKs
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // グローバル変数から設定を読み込み
        const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
        const appId = window.__app_id || 'diet-partner-default';
        const initialAuthToken = window.__initial_auth_token;

        // Firebase初期化
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Reactコンポーネントで使用するためにwindowオブジェクトに公開（またはコンテキスト経由でも良いが簡易的に）
        window.db = db;
        window.auth = auth;
        window.appId = appId;
        window.initialAuthToken = initialAuthToken;
        window.signInWithCustomToken = signInWithCustomToken;
        window.signInAnonymously = signInAnonymously;
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Activity, Utensils, Bed, CheckCircle, Scale, Calendar, Trophy, 
            ChevronRight, RefreshCw, AlertCircle, TrendingDown, Moon, 
            Camera, Loader2, Sparkles, Coffee, Sun, Sunset, Flame, Ban, 
            Undo2, Award, Star, Settings, X, Key, BrainCircuit, ImageIcon, Trash2, Cloud, CloudOff
        } from 'lucide-react';

        // Firebase関連の関数はグローバルから取得
        const { db, auth, appId, initialAuthToken, signInWithCustomToken, signInAnonymously } = window;
        import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { collection, doc, setDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // ロードマップに基づくベースプラン
        const WEEKLY_PLAN_BASE = {
            0: { day: '日曜日', type: 'adjustment', title: '調整日 & チートミール', targetCalories: 1600, workout: '完全休養 または 軽い散歩', workoutDetail: '今日は心と体を休める日です。', sleepAdvice: '明日の仕事に備え早めに就寝。', dietDetail: { breakfast: '軽め', lunch: 'チートミールOK', dinner: '調整食', focus: '1食は自由に' }, color: 'bg-green-100 border-green-500 text-green-800' },
            1: { day: '月曜日', type: 'home', title: '自宅トレ(軽) & 仕事モード', targetCalories: 1750, workout: 'スクワット・ストレッチ', workoutDetail: 'ポモドーロ・スクワット：50分仕事→10回スクワット', sleepAdvice: '23時までには就寝。', dietDetail: { breakfast: '和食推奨', lunch: '定食スタイル', dinner: '主菜＋サラダ', focus: '週末のリセット' }, color: 'bg-blue-100 border-blue-500 text-blue-800' },
            2: { day: '火曜日', type: 'gym', title: 'ジム (筋トレA: 脚・胸)', targetCalories: 1950, workout: '下半身・胸メイン＋有酸素', workoutDetail: 'レッグプレス、チェストプレス各10回×3', sleepAdvice: 'マグネシウムを摂取してリラックス。', dietDetail: { breakfast: 'オートミール等', lunch: 'トレ前におにぎり', dinner: '赤身肉でリカバリー', focus: 'トレ前後の栄養補給' }, color: 'bg-red-100 border-red-500 text-red-800' },
            3: { day: '水曜日', type: 'rest', title: '完全休養日', targetCalories: 1600, workout: 'オフ（睡眠優先）', workoutDetail: 'トレーニング禁止。ストレッチのみOK。', sleepAdvice: '目標7.5時間睡眠。', dietDetail: { breakfast: 'スムージー等', lunch: '蕎麦やうどん', dinner: '鍋物やポトフ', focus: '内臓を休める' }, color: 'bg-indigo-100 border-indigo-500 text-indigo-800' },
            4: { day: '木曜日', type: 'home', title: '自宅トレ(軽)', targetCalories: 1750, workout: '散歩 または ストレッチ', workoutDetail: '朝イチまたは夕方に20分の早歩き', sleepAdvice: 'アロマなどでリラックス。', dietDetail: { breakfast: '卵とブロッコリー', lunch: 'コンビニならサラダチキン', dinner: '白身魚', focus: '間食に注意' }, color: 'bg-blue-100 border-blue-500 text-blue-800' },
            5: { day: '金曜日', type: 'gym', title: 'ジム (筋トレB: 背中・腹)', targetCalories: 1950, workout: '背中・腹筋メイン＋有酸素', workoutDetail: 'ラットプルダウン、クランチ', sleepAdvice: '夜更かし注意。', dietDetail: { breakfast: 'しっかり食べる', lunch: 'パスタ等は避ける', dinner: '居酒屋メニュー風（ヘルシーに）', focus: 'お酒は蒸留酒' }, color: 'bg-red-100 border-red-500 text-red-800' },
            6: { day: '土曜日', type: 'cardio', title: '有酸素強化 (ラン/HIIT)', targetCalories: 1850, workout: 'ランニング または HIIT', workoutDetail: '脂肪燃焼デー。ラン30分 or HIIT 4分', sleepAdvice: '運動の疲れで深く眠る。', dietDetail: { breakfast: 'バナナ＋プロテイン', lunch: '炭水化物OK', dinner: 'きのこ・海藻', focus: '水分をたっぷり' }, color: 'bg-orange-100 border-orange-500 text-orange-800' }
        };

        const INITIAL_GOAL = { weight: 65.0, bfp: 15.0, startWeight: 84.6, startBfp: 20.4 };

        // 簡易グラフコンポーネント
        const SimpleChart = ({ data, dataKey, color, label, unit, domain }) => {
            if (!data || data.length < 2) {
                return <div className="h-32 bg-slate-50 rounded-lg flex items-center justify-center border border-slate-100 text-slate-400 text-sm">データ不足</div>;
            }
            const values = data.map(d => d[dataKey]);
            const min = Math.min(...values, domain[0]);
            const max = Math.max(...values, domain[1]);
            const range = max - min || 1;
            const points = data.map((d, i) => {
                const x = (i / (data.length - 1)) * 100;
                const y = 100 - ((d[dataKey] - min) / range) * 100;
                return `${x},${y}`;
            }).join(' ');

            return (
                <div className="mb-4">
                    <div className="flex justify-between text-xs text-slate-500 mb-1 font-medium">
                        <span>{label}推移</span>
                        <span>Current: {values[values.length - 1]}{unit}</span>
                    </div>
                    <div className="h-24 w-full bg-white border border-slate-100 rounded-lg relative overflow-hidden p-2">
                        <svg viewBox="0 0 100 100" preserveAspectRatio="none" className="w-full h-full overflow-visible">
                            <polyline fill="none" stroke={color} strokeWidth="2" points={points} vectorEffect="non-scaling-stroke" />
                            {data.map((d, i) => <circle key={i} cx={(i / (data.length - 1)) * 100} cy={100 - ((d[dataKey] - min) / range) * 100} r="1.5" fill={color} className="opacity-80" />)}
                        </svg>
                    </div>
                </div>
            );
        };

        // メインコンポーネント
        function DietPartnerApp() {
            const [user, setUser] = useState(null);
            const [today, setToday] = useState(new Date());
            const [loading, setLoading] = useState(true);
            const [syncError, setSyncError] = useState(false);

            // データステート
            const [profile, setProfile] = useState({ weight: 84.6, bfp: 20.4, apiKey: "" });
            const [history, setHistory] = useState([
                { date: new Date(Date.now() - 86400000 * 2).toISOString(), weight: 85.0, bfp: 20.8 },
                { date: new Date(Date.now() - 86400000).toISOString(), weight: 84.8, bfp: 20.5 },
                { date: new Date().toISOString(), weight: 84.6, bfp: 20.4 }
            ]);
            const [dailyData, setDailyData] = useState({
                date: new Date().toISOString(),
                sleepHours: 6,
                feeling: 'normal',
                isCheckedIn: false,
                tasks: { meal: false, workout: false, sleep: false },
                isFinished: false,
                dailyFeedback: null,
                // 画像は容量制限のためFirestoreには保存せず、メモリ内のみとする（リロードで消える仕様）
                dailyImage: null 
            });
            const [mealLogs, setMealLogs] = useState({
                breakfast: { image: null, result: null, skipped: false },
                lunch: { image: null, result: null, skipped: false },
                dinner: { image: null, result: null, skipped: false }
            });
            const [aiPlan, setAiPlan] = useState(null);

            const [showSettings, setShowSettings] = useState(false);
            const [tempApiKey, setTempApiKey] = useState("");
            const [analyzing, setAnalyzing] = useState(false);
            const [finishing, setFinishing] = useState(false);
            const [isPlanLoading, setIsPlanLoading] = useState(false);
            const fileInputRef = useRef(null);

            // 今日の日付文字列
            const todayStr = useMemo(() => new Date().toDateString(), [today]);
            const todayDocId = useMemo(() => {
                const d = new Date();
                return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            }, [today]);

            const plan = useMemo(() => {
                if (aiPlan) return aiPlan;
                return WEEKLY_PLAN_BASE[today.getDay()];
            }, [today, aiPlan]);

            // 認証と初期化
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Auth failed", error);
                        setSyncError(true);
                    }
                };
                initAuth();

                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    if (!currentUser) setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            // Firestore データ同期
            useEffect(() => {
                if (!user) return;

                const userDocRef = (col) => doc(db, 'artifacts', appId, 'users', user.uid, 'diet_data', col);

                // プロファイル監視
                const unsubProfile = onSnapshot(userDocRef('profile'), (docSnap) => {
                    if (docSnap.exists()) {
                        setProfile(prev => ({ ...prev, ...docSnap.data() }));
                    }
                }, (err) => { console.error(err); setSyncError(true); });

                // 履歴監視
                const unsubHistory = onSnapshot(userDocRef('history'), (docSnap) => {
                    if (docSnap.exists()) {
                        setHistory(docSnap.data().records || []);
                    }
                });

                // 今日のデータ監視
                const unsubDaily = onSnapshot(userDocRef(todayDocId), (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setDailyData(prev => ({ ...prev, ...data.checkIn }));
                        if (data.mealLogs) setMealLogs(data.mealLogs);
                        if (data.aiPlan) setAiPlan(data.aiPlan);
                    } else {
                        // 日付が変わってデータがない場合のリセットはここで行われる
                        setLoading(false); 
                    }
                    setLoading(false);
                });

                return () => {
                    unsubProfile();
                    unsubHistory();
                    unsubDaily();
                };
            }, [user, todayDocId]);

            // データ保存ヘルパー
            const saveDailyData = async (newCheckIn, newMealLogs, newAiPlan) => {
                if (!user) return;
                const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'diet_data', todayDocId);
                // 画像データ(Base64)は重いので保存から除外
                const cleanCheckIn = { ...newCheckIn, dailyImage: null }; 
                const cleanMealLogs = {};
                Object.keys(newMealLogs || mealLogs).forEach(key => {
                    cleanMealLogs[key] = { 
                        ...newMealLogs?.[key] || mealLogs[key], 
                        image: null // 食事画像もDBには保存しない
                    };
                });

                await setDoc(docRef, {
                    checkIn: cleanCheckIn,
                    mealLogs: cleanMealLogs,
                    aiPlan: newAiPlan || aiPlan,
                    updatedAt: new Date().toISOString()
                }, { merge: true });
            };

            const saveProfile = async (newProfile) => {
                if (!user) return;
                const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'diet_data', 'profile');
                await setDoc(docRef, newProfile, { merge: true });
            };

            const saveHistory = async (newHistory) => {
                if (!user) return;
                const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'diet_data', 'history');
                await setDoc(docRef, { records: newHistory }, { merge: true });
            };

            // ハンドラー群
            const handleSaveApiKey = () => {
                const newProfile = { ...profile, apiKey: tempApiKey };
                setProfile(newProfile);
                saveProfile(newProfile);
                setShowSettings(false);
                alert("APIキーをクラウドに保存しました！");
            };

            const openSettings = () => {
                setTempApiKey(profile.apiKey || "");
                setShowSettings(true);
            };

            const handleStatusChange = (e) => {
                const { name, value } = e.target;
                setProfile(prev => ({ ...prev, [name]: parseFloat(value) }));
            };

            // 今日の最適プランを生成
            const generateDailyPlan = async (status, sleep) => {
                if (!profile.apiKey) return;
                setIsPlanLoading(true);

                const dayOfWeek = ['日', '月', '火', '水', '木', '金', '土'][today.getDay()];
                const recentHistory = history.slice(-3).map(h => 
                    `- ${new Date(h.date).toLocaleDateString()}: ${h.weight}kg`
                ).join('\n');

                const prompt = `
                    あなたはプロのダイエットインストラクターです。
                    クライアントの今日のコンディションと過去の履歴に基づいて、今日1日の最適なスケジュールをJSONで作成してください。
                    目標: 65kg / 15% (現在: ${status.weight}kg / ${status.bfp}%)
                    曜日: ${dayOfWeek}, 睡眠: ${sleep}時間
                    履歴: ${recentHistory}
                    指示: 睡眠6h未満はリカバリー優先。体重増減に応じたアドバイス。
                    JSONフォーマット:
                    { "day": "${dayOfWeek}曜日", "title": "テーマ", "type": "rest/home/gym/cardio/adjustment", "targetCalories": 1800, "workout": "メイン指示", "workoutDetail": "詳細", "sleepAdvice": "睡眠", "dietDetail": { "breakfast": "", "lunch": "", "dinner": "", "focus": "" }, "color": "bg-indigo-100 border-indigo-500 text-indigo-800" }
                `;

                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${profile.apiKey}`;

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await response.json();
                    if (data.candidates && data.candidates[0].content) {
                        const text = data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
                        const generated = JSON.parse(text);
                        setAiPlan(generated);
                        saveDailyData(dailyData, mealLogs, generated);
                    }
                } catch (error) {
                    console.error('Plan generation failed:', error);
                } finally {
                    setIsPlanLoading(false);
                }
            };

            const handleCheckInSubmit = async (e) => {
                e.preventDefault();
                const newEntry = {
                    date: new Date().toISOString(),
                    weight: profile.weight,
                    bfp: profile.bfp
                };
                
                // 履歴更新
                const todayStr = new Date().toDateString();
                const newHistory = [...history];
                const existingIndex = newHistory.findIndex(h => new Date(h.date).toDateString() === todayStr);
                
                if (existingIndex >= 0) {
                    newHistory[existingIndex] = newEntry;
                } else {
                    newHistory.push(newEntry);
                }
                setHistory(newHistory);
                saveHistory(newHistory); // クラウド保存
                
                // プロファイル保存
                saveProfile(profile);

                // 今日のデータ更新
                const newCheckIn = { 
                    ...dailyData, 
                    isCheckedIn: true, 
                    date: new Date().toISOString(),
                    isFinished: false,
                    dailyFeedback: null,
                    dailyImage: null
                };
                setDailyData(newCheckIn);
                saveDailyData(newCheckIn, mealLogs, aiPlan);

                if (profile.apiKey) {
                    await generateDailyPlan(profile, dailyData.sleepHours);
                }
            };

            const toggleTask = (taskName) => {
                if (dailyData.isFinished) return;
                const newTasks = { ...dailyData.tasks, [taskName]: !dailyData.tasks[taskName] };
                const newCheckIn = { ...dailyData, tasks: newTasks };
                setDailyData(newCheckIn);
                saveDailyData(newCheckIn, mealLogs, aiPlan);
            };

            const handleSkipMeal = (mealType) => {
                if (dailyData.isFinished) return;
                if (window.confirm('欠食として記録しますか？')) {
                    const newMealLogs = { ...mealLogs, [mealType]: { image: null, result: null, skipped: true } };
                    setMealLogs(newMealLogs);
                    saveDailyData(dailyData, newMealLogs, aiPlan);
                }
            };

            const handleResetMeal = (mealType) => {
                if (dailyData.isFinished) return;
                const newMealLogs = { ...mealLogs, [mealType]: { image: null, result: null, skipped: false } };
                setMealLogs(newMealLogs);
                saveDailyData(dailyData, newMealLogs, aiPlan);
            };

            const handleImageUpload = (event) => {
                if (dailyData.isFinished) return;
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        // 表示用にローカルStateにはセットするが、DB保存時にはimage: nullにする
                        setMealLogs(prev => ({
                            ...prev,
                            [activeMeal]: { ...prev[activeMeal], image: reader.result }
                        }));
                        analyzeImage(reader.result, activeMeal);
                    };
                    reader.readAsDataURL(file);
                }
                event.target.value = '';
            };

            const analyzeImage = async (base64Image, mealType) => {
                if (!profile.apiKey) {
                    alert("APIキーが設定されていません。");
                    openSettings();
                    return;
                }
                setAnalyzing(true);
                const base64Data = base64Image.split(',')[1];
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${profile.apiKey}`;
                const payload = {
                    contents: [{ parts: [
                        { text: "料理画像を分析し、料理名、推定カロリー(kcal)、PFC(g)、アドバイスをJSON(name, calories, protein, fat, carbs, advice)で出力。" },
                        { inlineData: { mimeType: "image/jpeg", data: base64Data } }
                    ] }],
                    generationConfig: { responseMimeType: "application/json" }
                };

                try {
                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const data = await response.json();
                    if (data.candidates) {
                        const result = JSON.parse(data.candidates[0].content.parts[0].text);
                        const newMealLogs = {
                            ...mealLogs,
                            [mealType]: { image: base64Image, result: result, skipped: false }
                        };
                        setMealLogs(newMealLogs);
                        saveDailyData(dailyData, newMealLogs, aiPlan); // 結果は保存（画像は除外される）
                    }
                } catch (error) {
                    alert('解析失敗: APIキーなどを確認してください');
                } finally {
                    setAnalyzing(false);
                }
            };

            const totalCalories = useMemo(() => Object.values(mealLogs).reduce((sum, meal) => sum + (meal.result?.calories || 0), 0), [mealLogs]);
            const caloriesProgress = useMemo(() => Math.min(100, (totalCalories / plan.targetCalories) * 100), [totalCalories, plan]);

            const handleFinishDay = async () => {
                if (!window.confirm("1日の記録を確定しますか？")) return;
                if (!profile.apiKey) {
                    alert("APIキーがないため記録のみ保存します。");
                    const newCheckIn = { ...dailyData, isFinished: true, dailyFeedback: "記録完了。APIキーを設定するとAIコメントがもらえます。" };
                    setDailyData(newCheckIn);
                    saveDailyData(newCheckIn, mealLogs, aiPlan);
                    return;
                }

                setFinishing(true);
                const textPrompt = `ダイエットコーチとして、今日の成果に100文字以内のフィードバックを。目標65kg, 現在${profile.weight}kg, 摂取${totalCalories}/${plan.targetCalories}kcal, タスク達成:食${dailyData.tasks.meal?1:0}/運${dailyData.tasks.workout?1:0}/睡${dailyData.tasks.sleep?1:0}`;
                const textUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${profile.apiKey}`;
                const imageUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${profile.apiKey}`;

                let generatedFeedback = "お疲れ様！";
                let generatedImage = null;

                try {
                    // Text
                    const textRes = await fetch(textUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: textPrompt }] }] }) });
                    const textData = await textRes.json();
                    if(textData.candidates) generatedFeedback = textData.candidates[0].content.parts[0].text;

                    // Image
                    const feelingPrompt = dailyData.tasks.workout ? "energetic, powerful" : "relaxing, peaceful";
                    const imagePrompt = `Anime style fitness motivation poster, Theme: ${feelingPrompt}, A fit person giving a thumbs up, bright lighting.`;
                    const imgRes = await fetch(imageUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ instances: [{ prompt: imagePrompt }], parameters: { sampleCount: 1 } }) });
                    const imgData = await imgRes.json();
                    if(imgData.predictions?.[0]?.bytesBase64Encoded) generatedImage = `data:image/png;base64,${imgData.predictions[0].bytesBase64Encoded}`;

                } catch (e) { console.error(e); generatedFeedback += " (通信エラーあり)"; }

                const newCheckIn = { ...dailyData, isFinished: true, dailyFeedback: generatedFeedback, dailyImage: generatedImage };
                setDailyData(newCheckIn);
                saveDailyData(newCheckIn, mealLogs, aiPlan); // 画像は保存されない点に注意
                setFinishing(false);
                setTimeout(() => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }), 100);
            };

            const handleDailyReset = () => {
                if(window.confirm('今日の記録をリセットしますか？')) {
                    const newCheckIn = { 
                        date: new Date().toISOString(),
                        sleepHours: 6,
                        feeling: 'normal',
                        isCheckedIn: false,
                        tasks: { meal: false, workout: false, sleep: false },
                        isFinished: false,
                        dailyFeedback: null,
                        dailyImage: null
                    };
                    const newMealLogs = {
                        breakfast: { image: null, result: null, skipped: false },
                        lunch: { image: null, result: null, skipped: false },
                        dinner: { image: null, result: null, skipped: false }
                    };
                    setDailyData(newCheckIn);
                    setMealLogs(newMealLogs);
                    setAiPlan(null);
                    saveDailyData(newCheckIn, newMealLogs, null);
                }
            };

            if (loading) return <div className="min-h-screen flex items-center justify-center text-slate-500"><Loader2 className="w-10 h-10 animate-spin" /></div>;

            return (
                <div className="min-h-screen bg-slate-50 text-slate-800 font-sans pb-24">
                    {/* Header */}
                    <header className="bg-slate-900 text-white p-6 rounded-b-3xl shadow-lg relative overflow-hidden">
                        <div className="absolute top-0 right-0 w-32 h-32 bg-emerald-500 rounded-full blur-3xl opacity-20 -mr-10 -mt-10"></div>
                        <div className="flex justify-between items-center mb-6 relative z-10">
                            <div>
                                <h1 className="text-xl font-bold flex items-center gap-2">
                                    <Activity className="w-5 h-5 text-emerald-400" /> Diet Partner
                                    {syncError && <CloudOff className="w-4 h-4 text-red-400" />}
                                    {!syncError && <Cloud className="w-4 h-4 text-emerald-400" />}
                                </h1>
                                <p className="text-slate-400 text-xs mt-1">Goal: 65kg / 15%</p>
                            </div>
                            <div className="flex items-center gap-3">
                                <div className="text-right"><p className="text-xs text-slate-400">{today.toLocaleDateString()}</p><p className="font-bold text-lg">{plan.day}</p></div>
                                <button onClick={openSettings} className="bg-white/10 hover:bg-white/20 p-2 rounded-full"><Settings className="w-5 h-5 text-slate-200" /></button>
                            </div>
                        </div>
                        {dailyData.isCheckedIn && (
                            <div className="space-y-4 relative z-10">
                                <div className="flex justify-between items-center">
                                    <div className="bg-slate-800/50 p-3 rounded-lg w-[48%] backdrop-blur-sm">
                                        <p className="text-xs text-slate-400">体重</p>
                                        <div className="flex items-baseline gap-1"><span className="text-2xl font-bold">{profile.weight}</span><span className="text-xs">kg</span></div>
                                        <p className="text-xs text-emerald-400 flex items-center gap-1"><TrendingDown className="w-3 h-3" />あと {(profile.weight - INITIAL_GOAL.weight).toFixed(1)}kg</p>
                                    </div>
                                    <div className="bg-slate-800/50 p-3 rounded-lg w-[48%] backdrop-blur-sm">
                                        <p className="text-xs text-slate-400">体脂肪率</p>
                                        <div className="flex items-baseline gap-1"><span className="text-2xl font-bold">{profile.bfp}</span><span className="text-xs">%</span></div>
                                        <p className="text-xs text-emerald-400 flex items-center gap-1"><TrendingDown className="w-3 h-3" />あと {(profile.bfp - INITIAL_GOAL.bfp).toFixed(1)}%</p>
                                    </div>
                                </div>
                                <div className="bg-white/5 p-3 rounded-xl border border-white/10">
                                    <SimpleChart data={history.slice(-14)} dataKey="weight" color="#34d399" label="Weight" unit="kg" domain={[INITIAL_GOAL.weight, INITIAL_GOAL.startWeight]} />
                                </div>
                            </div>
                        )}
                    </header>

                    <main className="max-w-md mx-auto px-4 -mt-4 relative z-20">
                        {!dailyData.isCheckedIn ? (
                            <div className="bg-white rounded-xl shadow-xl p-6 mb-6 border border-slate-100">
                                <h2 className="text-lg font-bold mb-4 flex items-center gap-2 text-slate-700"><Scale className="w-5 h-5 text-blue-500" /> モーニング・チェックイン</h2>
                                <form onSubmit={handleCheckInSubmit} className="space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="block text-xs font-bold text-slate-500 mb-1">体重 (kg)</label><input type="number" step="0.1" name="weight" value={profile.weight} onChange={handleStatusChange} className="w-full p-3 border border-slate-200 rounded-lg text-xl font-bold text-slate-800 focus:ring-2 focus:ring-blue-500 outline-none" required /></div>
                                        <div><label className="block text-xs font-bold text-slate-500 mb-1">体脂肪率 (%)</label><input type="number" step="0.1" name="bfp" value={profile.bfp} onChange={handleStatusChange} className="w-full p-3 border border-slate-200 rounded-lg text-xl font-bold text-slate-800 focus:ring-2 focus:ring-blue-500 outline-none" required /></div>
                                    </div>
                                    <div><label className="block text-xs font-bold text-slate-500 mb-1">昨晩の睡眠 (時間)</label><input type="number" step="0.5" value={dailyData.sleepHours} onChange={(e) => setDailyData({...dailyData, sleepHours: parseFloat(e.target.value)})} className="w-full p-3 border border-slate-200 rounded-lg text-xl font-bold text-slate-800 focus:ring-2 focus:ring-blue-500 outline-none" required /></div>
                                    <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-md flex items-center justify-center gap-2">記録してスタート <ChevronRight className="w-5 h-5" /></button>
                                </form>
                            </div>
                        ) : (
                            <div className="space-y-6 pt-4">
                                {/* Sleep Alert */}
                                {dailyData.sleepHours < 6.5 && (
                                    <div className="bg-amber-50 border-l-4 border-amber-500 p-4 rounded-r-lg shadow-sm flex items-start gap-3">
                                        <AlertCircle className="w-6 h-6 text-amber-500 flex-shrink-0 mt-1" />
                                        <div><h3 className="font-bold text-amber-800 text-sm">睡眠不足アラート</h3><p className="text-xs text-amber-700 mt-1">睡眠{dailyData.sleepHours}時間。カフェインは14時まで、仮眠推奨。</p></div>
                                    </div>
                                )}

                                {/* Daily Plan */}
                                <section className={`rounded-xl shadow-lg border-2 overflow-hidden ${plan.color.replace('text-', 'border-').replace('bg-', 'bg-white ')}`}>
                                    <div className={`p-4 ${plan.color} flex justify-between items-center`}>
                                        <h2 className="font-bold text-lg flex items-center gap-2"><Calendar className="w-5 h-5" /> {isPlanLoading ? "最適化中..." : "今日のミッション"}</h2>
                                        <span className="text-xs font-bold px-2 py-1 bg-white/60 rounded text-slate-800 uppercase tracking-wider">{plan.type}</span>
                                    </div>
                                    <div className="p-5 bg-white relative">
                                        {isPlanLoading && <div className="absolute inset-0 bg-white/90 z-10 flex flex-col items-center justify-center text-slate-500"><Loader2 className="w-10 h-10 animate-spin text-blue-500 mb-2" /><p className="text-sm font-bold animate-pulse">AIがプラン生成中...</p></div>}
                                        <h3 className="text-2xl font-bold text-slate-800 mb-3 flex items-center gap-2">{plan.title} {aiPlan && <Sparkles className="w-5 h-5 text-yellow-500" />}</h3>
                                        <div className="space-y-4">
                                            <div className="bg-slate-50 p-4 rounded-lg border border-slate-100"><div className="flex items-center gap-2 mb-2"><Activity className="w-4 h-4 text-blue-500" /><p className="text-sm font-bold text-slate-700">運動指示</p></div><p className="text-slate-700 font-bold mb-1">{plan.workout}</p><p className="text-xs text-slate-500 border-t border-slate-200 pt-2 mt-2">{plan.workoutDetail}</p></div>
                                            <div className="bg-slate-50 p-4 rounded-lg border border-slate-100">
                                                <div className="flex items-center justify-between mb-2"><div className="flex items-center gap-2"><Utensils className="w-4 h-4 text-emerald-500" /><p className="text-sm font-bold text-slate-700">食事ガイド</p></div><div className="flex items-center gap-1 text-xs font-bold bg-white px-2 py-1 rounded border border-slate-200 text-emerald-600"><Flame className="w-3 h-3 fill-emerald-600" /> 目標: {plan.targetCalories} kcal</div></div>
                                                <ul className="text-xs text-slate-600 space-y-2 mb-3"><li><span className="font-bold text-emerald-600">朝:</span> {plan.dietDetail.breakfast}</li><li><span className="font-bold text-emerald-600">昼:</span> {plan.dietDetail.lunch}</li><li><span className="font-bold text-emerald-600">夜:</span> {plan.dietDetail.dinner}</li></ul>
                                                <div className="bg-emerald-50 p-2 rounded text-xs text-emerald-800 font-bold border border-emerald-100">POINT: {plan.dietDetail.focus}</div>
                                            </div>
                                        </div>
                                    </div>
                                </section>

                                {/* Meal Logs & AI Analysis */}
                                <section className={`bg-gradient-to-r from-emerald-500 to-teal-600 rounded-xl shadow-lg p-5 text-white transition-opacity ${dailyData.isFinished ? 'opacity-75 pointer-events-none grayscale-[0.5]' : ''}`}>
                                    <div className="flex justify-between items-center mb-4">
                                        <div>
                                            <h3 className="font-bold flex items-center gap-2"><Camera className="w-5 h-5" /> 食事記録 & AI分析</h3>
                                            <div className="flex items-baseline gap-2 mt-1"><p className="text-xs text-emerald-100 opacity-90">Total: <span className="text-lg font-bold">{totalCalories}</span> / {plan.targetCalories} kcal</p><span className={`text-xs font-bold px-1.5 rounded ${totalCalories > plan.targetCalories ? 'bg-red-500' : 'bg-emerald-700'}`}>{caloriesProgress.toFixed(0)}%</span></div>
                                            <div className="w-full bg-black/20 h-1.5 rounded-full mt-1 max-w-[200px]"><div className={`h-full rounded-full transition-all duration-500 ${totalCalories > plan.targetCalories ? 'bg-red-400' : 'bg-white'}`} style={{ width: `${Math.min(100, (totalCalories / plan.targetCalories) * 100)}%` }}></div></div>
                                        </div>
                                        <span className="text-xs bg-white/20 px-2 py-1 rounded text-white font-bold">Imagen 4</span>
                                    </div>
                                    <div className="flex p-1 bg-black/20 rounded-lg mb-4">
                                        {[{ id: 'breakfast', icon: Coffee, label: '朝' }, { id: 'lunch', icon: Sun, label: '昼' }, { id: 'dinner', icon: Sunset, label: '夜' }].map((meal) => (
                                            <button key={meal.id} onClick={() => setActiveMeal(meal.id)} className={`flex-1 flex items-center justify-center gap-1 py-2 rounded-md text-sm font-bold transition-all ${activeMeal === meal.id ? 'bg-white text-teal-700 shadow-sm' : 'text-white/60 hover:bg-white/10'}`}>
                                                <meal.icon className="w-3 h-3" /> {meal.label} {mealLogs[meal.id].result && <span className="ml-1 w-2 h-2 rounded-full bg-emerald-400"></span>}{mealLogs[meal.id].skipped && <span className="ml-1 w-2 h-2 rounded-full bg-slate-400"></span>}
                                            </button>
                                        ))}
                                    </div>
                                    <div className="animate-in fade-in slide-in-from-right-2 duration-300" key={activeMeal}>
                                        {mealLogs[activeMeal].skipped ? (
                                            <div className="bg-black/20 rounded-lg p-6 flex flex-col items-center justify-center text-center"><Ban className="w-10 h-10 text-white/50 mb-2" /><p className="font-bold text-white">欠食 (Skipped)</p><button onClick={() => handleResetMeal(activeMeal)} className="mt-2 bg-white/20 text-xs px-4 py-2 rounded-full flex items-center gap-1"><Undo2 className="w-3 h-3" /> 取消</button></div>
                                        ) : !mealLogs[activeMeal].image ? (
                                            <div className="space-y-3">
                                                <button onClick={() => fileInputRef.current.click()} className="w-full bg-white/10 hover:bg-white/20 border-2 border-dashed border-white/30 rounded-lg p-6 flex flex-col items-center justify-center"><Camera className="w-8 h-8 mb-2 text-white/80" /><span className="text-sm font-bold">写真を撮る</span><input type="file" ref={fileInputRef} accept="image/*" className="hidden" onChange={handleImageUpload} /></button>
                                                <button onClick={() => handleSkipMeal(activeMeal)} className="w-full text-white/60 text-xs py-2 flex items-center justify-center gap-1"><Ban className="w-3 h-3" /> 欠食記録</button>
                                            </div>
                                        ) : (
                                            <div className="space-y-4">
                                                <div className="relative rounded-lg overflow-hidden h-40 bg-black/20 flex items-center justify-center">
                                                    <img src={mealLogs[activeMeal].image} alt="Food" className="h-full w-full object-cover opacity-90" />
                                                    {analyzing ? <div className="absolute inset-0 bg-black/40 flex flex-col items-center justify-center"><Loader2 className="w-8 h-8 animate-spin text-white mb-2" /><span className="text-sm font-bold">AI分析中...</span></div> : 
                                                    <button onClick={() => handleResetMeal(activeMeal)} className="absolute top-2 right-2 bg-black/50 p-1.5 rounded-full text-white hover:bg-black/70"><RefreshCw className="w-4 h-4" /></button>}
                                                </div>
                                                {mealLogs[activeMeal].result && (
                                                    <div className="bg-white text-slate-800 rounded-lg p-4 shadow-sm">
                                                        <h4 className="font-bold text-lg mb-1 border-b border-slate-100 pb-2 flex justify-between">{mealLogs[activeMeal].result.name}<span className="text-emerald-600 font-extrabold">{mealLogs[activeMeal].result.calories} kcal</span></h4>
                                                        <div className="grid grid-cols-3 gap-2 my-3 text-center">
                                                            <div className="bg-red-50 p-2 rounded"><p className="text-[10px] text-red-500 font-bold">PRO</p><p className="font-bold text-red-700">{mealLogs[activeMeal].result.protein}g</p></div>
                                                            <div className="bg-yellow-50 p-2 rounded"><p className="text-[10px] text-yellow-500 font-bold">FAT</p><p className="font-bold text-yellow-700">{mealLogs[activeMeal].result.fat}g</p></div>
                                                            <div className="bg-blue-50 p-2 rounded"><p className="text-[10px] text-blue-500 font-bold">CARB</p><p className="font-bold text-blue-700">{mealLogs[activeMeal].result.carbs}g</p></div>
                                                        </div>
                                                        <div className="bg-slate-50 p-3 rounded text-sm text-slate-600 flex gap-2 items-start"><Sparkles className="w-4 h-4 text-yellow-500 flex-shrink-0 mt-0.5" /><p className="text-xs">{mealLogs[activeMeal].result.advice}</p></div>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </section>

                                {/* Check List */}
                                <section className={`bg-white rounded-xl shadow-md p-5 border border-slate-100 transition-opacity ${dailyData.isFinished ? 'opacity-75 pointer-events-none' : ''}`}>
                                    <h3 className="font-bold text-lg text-slate-700 mb-4 flex items-center gap-2"><Trophy className="w-5 h-5 text-yellow-500" /> 完了報告</h3>
                                    <div className="space-y-3">
                                        <button onClick={() => toggleTask('meal')} className={`w-full p-4 rounded-lg border transition-all flex items-center gap-3 text-left ${dailyData.tasks.meal ? 'bg-emerald-50 border-emerald-500' : 'bg-white hover:border-emerald-300'}`}>
                                            <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${dailyData.tasks.meal ? 'bg-emerald-500 border-emerald-500' : 'border-slate-300'}`}>{dailyData.tasks.meal && <CheckCircle className="w-4 h-4 text-white" />}</div>
                                            <div><span className={`block text-sm ${dailyData.tasks.meal ? 'text-emerald-900 font-bold' : 'text-slate-700 font-medium'}`}>食事ルールを守った</span></div>
                                        </button>
                                        <button onClick={() => toggleTask('workout')} className={`w-full p-4 rounded-lg border transition-all flex items-center gap-3 text-left ${dailyData.tasks.workout ? 'bg-blue-50 border-blue-500' : 'bg-white hover:border-blue-300'}`}>
                                            <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${dailyData.tasks.workout ? 'bg-blue-500 border-blue-500' : 'border-slate-300'}`}>{dailyData.tasks.workout && <CheckCircle className="w-4 h-4 text-white" />}</div>
                                            <div><span className={`block text-sm ${dailyData.tasks.workout ? 'text-blue-900 font-bold' : 'text-slate-700 font-medium'}`}>ノルマ達成: {plan.workout}</span></div>
                                        </button>
                                        <button onClick={() => toggleTask('sleep')} className={`w-full p-4 rounded-lg border transition-all flex items-center gap-3 text-left ${dailyData.tasks.sleep ? 'bg-indigo-50 border-indigo-500' : 'bg-white hover:border-indigo-300'}`}>
                                            <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${dailyData.tasks.sleep ? 'bg-indigo-500 border-indigo-500' : 'border-slate-300'}`}>{dailyData.tasks.sleep && <CheckCircle className="w-4 h-4 text-white" />}</div>
                                            <div><span className={`block text-sm ${dailyData.tasks.sleep ? 'text-indigo-900 font-bold' : 'text-slate-700 font-medium'}`}>就寝準備OK</span></div>
                                        </button>
                                    </div>
                                </section>

                                {/* Finish Button / Result */}
                                {!dailyData.isFinished ? (
                                    <div className="pt-2 pb-6">
                                        <button onClick={handleFinishDay} disabled={finishing} className={`w-full bg-slate-800 text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-2 transition-all active:scale-95 ${finishing ? 'opacity-70 cursor-wait' : 'hover:bg-slate-700'}`}>
                                            {finishing ? <><Loader2 className="w-5 h-5 animate-spin" /> 作成中...</> : <><CheckCircle className="w-5 h-5" /> 1日を終了して報告</>}
                                        </button>
                                        <p className="text-center text-xs text-slate-400 mt-2">※確定するとコメントと応援イラストが届きます</p>
                                    </div>
                                ) : (
                                    <div className="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl shadow-xl p-6 text-white mb-6 animate-in zoom-in-95 duration-500">
                                        <div className="flex items-center gap-2 mb-4"><Award className="w-8 h-8 text-yellow-300" /><div><h3 className="font-bold text-xl">Good Job!</h3><p className="text-xs text-indigo-100 opacity-90">活動記録を保存しました</p></div></div>
                                        <div className="bg-white/10 rounded-lg p-4 backdrop-blur-sm border border-white/20 relative mb-4">
                                            <div className="absolute -top-3 -left-2 bg-yellow-400 text-slate-900 text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm">INSTRUCTOR'S COMMENT</div>
                                            <div className="flex gap-3"><div className="w-10 h-10 rounded-full bg-slate-200 border-2 border-white flex items-center justify-center flex-shrink-0 text-2xl overflow-hidden">👨‍🏫</div><p className="text-sm leading-relaxed font-medium">{dailyData.dailyFeedback}</p></div>
                                        </div>
                                        {dailyData.dailyImage ? (
                                            <div className="rounded-lg overflow-hidden border-4 border-white/20 shadow-lg relative"><img src={dailyData.dailyImage} alt="Reward" className="w-full h-auto object-cover" /><div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-3"><p className="text-xs text-white font-bold flex items-center gap-1"><ImageIcon className="w-3 h-3" /> AI Generated Reward (Imagen 4)</p></div></div>
                                        ) : (
                                            <div className="bg-white/5 rounded-lg h-32 flex flex-col items-center justify-center text-white/50 border border-dashed border-white/20"><ImageIcon className="w-8 h-8 mb-1 opacity-50" /><span className="text-xs">No image (保存されません)</span></div>
                                        )}
                                        <div className="mt-4 flex justify-between items-center text-xs text-indigo-100"><span>明日もこの調子で！</span><div className="flex gap-1">{[1,2,3].map(i => <Star key={i} className="w-4 h-4 text-yellow-300 fill-yellow-300" />)}</div></div>
                                    </div>
                                )}

                                <div className="text-center pt-8 pb-4">
                                    <button onClick={handleDailyReset} className="text-xs text-slate-300 flex items-center justify-center gap-1 mx-auto hover:text-red-400 transition-colors"><RefreshCw className="w-3 h-3" /> 今日の記録をリセット</button>
                                </div>
                            </div>
                        )}
                    </main>
                    <footer className="fixed bottom-0 w-full bg-white/90 backdrop-blur border-t border-slate-200 p-3 text-center text-[10px] text-slate-400 z-50">Professional Diet Instructor System v3.0 (Cloud)</footer>

                    {/* Settings Modal */}
                    {showSettings && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
                                <div className="flex justify-between items-center mb-4"><h3 className="text-lg font-bold flex items-center gap-2"><Settings className="w-5 h-5 text-slate-500" /> 設定</h3><button onClick={() => setShowSettings(false)} className="text-slate-400 hover:text-slate-600"><X className="w-5 h-5" /></button></div>
                                <div className="space-y-4">
                                    <div><label className="block text-sm font-bold text-slate-600 mb-1">Google Gemini APIキー</label><input type="password" value={tempApiKey} onChange={(e) => setTempApiKey(e.target.value)} className="w-full p-2 border rounded-lg text-sm" placeholder="AIzaSy..." /><p className="text-xs text-slate-400 mt-1">※設定はクラウドに保存され、他端末でも有効になります。</p></div>
                                    <button onClick={handleSaveApiKey} className="w-full bg-emerald-600 text-white font-bold py-2 rounded-lg">保存する</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<DietPartnerApp />);
    </script>
</body>
</html>
