<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diet Partner App (Cloud Sync)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Import Maps for React & Icons -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1"
        }
    }
    </script>
    <style>
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        .animate-shimmer {
            animation: shimmer 2s infinite linear;
            background: linear-gradient(to right, #f1f5f9 4%, #e2e8f0 25%, #f1f5f9 36%);
            background-size: 1000px 100%;
        }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <!-- Firebase Setup -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // =================================================================
        // ã€é‡è¦ã€‘ã”è‡ªèº«ã®ç’°å¢ƒã§ä½¿ã†å ´åˆã¯ã€ä»¥ä¸‹ã®å€¤ã‚’æ›¸ãæ›ãˆã¦ãã ã•ã„
        // =================================================================
        // 1. Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ« (https://console.firebase.google.com/) ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
        // 2. Authenticationã§ã€ŒåŒ¿åãƒ­ã‚°ã‚¤ãƒ³ã€ã‚’æœ‰åŠ¹åŒ–
        // 3. Firestore Databaseã‚’ä½œæˆï¼ˆãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰æ¨å¥¨ï¼‰
        // 4. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š > ãƒã‚¤ã‚¢ãƒ—ãƒª > ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚’è¿½åŠ  ã—ã¦configã‚’å–å¾—
        // 5. ä»¥ä¸‹ã® { } ã®ä¸­èº«ã‚’ã€å–å¾—ã—ãŸå†…å®¹ã§æ›¸ãæ›ãˆã¦ãã ã•ã„
        const myFirebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        // =================================================================

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã§ã¯è‡ªå‹•æä¾›ã•ã‚Œã‚‹è¨­å®šã‚’ä½¿ã„ã€ãã‚Œä»¥å¤–ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ç­‰ï¼‰ã§ã¯ä¸Šè¨˜ã®è¨­å®šã‚’ä½¿ã„ã¾ã™
        const firebaseConfig = window.__firebase_config ? JSON.parse(window.__firebase_config) : myFirebaseConfig;
        
        // ã‚¢ãƒ—ãƒªIDï¼ˆFirestoreã®ä¿å­˜ãƒ‘ã‚¹ã«ä½¿ã‚ã‚Œã¾ã™ã€‚å¤‰æ›´ã—ã¦ã‚‚OKã§ã™ï¼‰
        const appId = window.__app_id || 'diet-partner-app';
        const initialAuthToken = window.__initial_auth_token;

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase initialization failed. Config might be missing.", e);
        }

        // Reactã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«windowã«å…¬é–‹
        window.db = db;
        window.auth = auth;
        window.appId = appId;
        window.initialAuthToken = initialAuthToken;
        window.signInWithCustomToken = signInWithCustomToken;
        window.signInAnonymously = signInAnonymously;
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Activity, Utensils, Bed, CheckCircle, Scale, Calendar, Trophy, 
            ChevronRight, RefreshCw, AlertCircle, TrendingDown, Moon, 
            Camera, Loader2, Sparkles, Coffee, Sun, Sunset, Flame, Ban, 
            Undo2, Award, Star, Settings, X, Key, BrainCircuit, ImageIcon, Trash2, Cloud, CloudOff
        } from 'lucide-react';

        // Firebase modules from CDN (for inside React)
        import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { doc, setDoc, onSnapshot, deleteDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã«åŸºã¥ããƒ™ãƒ¼ã‚¹ãƒ—ãƒ©ãƒ³
        const WEEKLY_PLAN_BASE = {
            0: { day: 'æ—¥æ›œæ—¥', type: 'adjustment', title: 'èª¿æ•´æ—¥ & ãƒãƒ¼ãƒˆãƒŸãƒ¼ãƒ«', targetCalories: 1600, workout: 'å®Œå…¨ä¼‘é¤Š ã¾ãŸã¯ è»½ã„æ•£æ­©', workoutDetail: 'ä»Šæ—¥ã¯å¿ƒã¨ä½“ã‚’ä¼‘ã‚ã‚‹æ—¥ã§ã™ã€‚', sleepAdvice: 'æ˜æ—¥ã®ä»•äº‹ã«å‚™ãˆæ—©ã‚ã«å°±å¯ã€‚', dietDetail: { breakfast: 'è»½ã‚', lunch: 'ãƒãƒ¼ãƒˆãƒŸãƒ¼ãƒ«OK', dinner: 'èª¿æ•´é£Ÿ', focus: '1é£Ÿã¯è‡ªç”±ã«' }, color: 'bg-green-100 border-green-500 text-green-800' },
            1: { day: 'æœˆæ›œæ—¥', type: 'home', title: 'è‡ªå®…ãƒˆãƒ¬(è»½) & ä»•äº‹ãƒ¢ãƒ¼ãƒ‰', targetCalories: 1750, workout: 'ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆãƒ»ã‚¹ãƒˆãƒ¬ãƒƒãƒ', workoutDetail: 'ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ãƒ»ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆï¼š50åˆ†ä»•äº‹â†’10å›ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ', sleepAdvice: '23æ™‚ã¾ã§ã«ã¯å°±å¯ã€‚', dietDetail: { breakfast: 'å’Œé£Ÿæ¨å¥¨', lunch: 'å®šé£Ÿã‚¹ã‚¿ã‚¤ãƒ«', dinner: 'ä¸»èœï¼‹ã‚µãƒ©ãƒ€', focus: 'é€±æœ«ã®ãƒªã‚»ãƒƒãƒˆ' }, color: 'bg-blue-100 border-blue-500 text-blue-800' },
            2: { day: 'ç«æ›œæ—¥', type: 'gym', title: 'ã‚¸ãƒ  (ç­‹ãƒˆãƒ¬A: è„šãƒ»èƒ¸)', targetCalories: 1950, workout: 'ä¸‹åŠèº«ãƒ»èƒ¸ãƒ¡ã‚¤ãƒ³ï¼‹æœ‰é…¸ç´ ', workoutDetail: 'ãƒ¬ãƒƒã‚°ãƒ—ãƒ¬ã‚¹ã€ãƒã‚§ã‚¹ãƒˆãƒ—ãƒ¬ã‚¹å„10å›Ã—3', sleepAdvice: 'ãƒã‚°ãƒã‚·ã‚¦ãƒ ã‚’æ‘‚å–ã—ã¦ãƒªãƒ©ãƒƒã‚¯ã‚¹ã€‚', dietDetail: { breakfast: 'ã‚ªãƒ¼ãƒˆãƒŸãƒ¼ãƒ«ç­‰', lunch: 'ãƒˆãƒ¬å‰ã«ãŠã«ãã‚Š', dinner: 'èµ¤èº«è‚‰ã§ãƒªã‚«ãƒãƒªãƒ¼', focus: 'ãƒˆãƒ¬å‰å¾Œã®æ „é¤Šè£œçµ¦' }, color: 'bg-red-100 border-red-500 text-red-800' },
            3: { day: 'æ°´æ›œæ—¥', type: 'rest', title: 'å®Œå…¨ä¼‘é¤Šæ—¥', targetCalories: 1600, workout: 'ã‚ªãƒ•ï¼ˆç¡çœ å„ªå…ˆï¼‰', workoutDetail: 'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç¦æ­¢ã€‚ã‚¹ãƒˆãƒ¬ãƒƒãƒã®ã¿OKã€‚', sleepAdvice: 'ç›®æ¨™7.5æ™‚é–“ç¡çœ ã€‚', dietDetail: { breakfast: 'ã‚¹ãƒ ãƒ¼ã‚¸ãƒ¼ç­‰', lunch: 'è•éº¦ã‚„ã†ã©ã‚“', dinner: 'é‹ç‰©ã‚„ãƒãƒˆãƒ•', focus: 'å†…è‡“ã‚’ä¼‘ã‚ã‚‹' }, color: 'bg-indigo-100 border-indigo-500 text-indigo-800' },
            4: { day: 'æœ¨æ›œæ—¥', type: 'home', title: 'è‡ªå®…ãƒˆãƒ¬(è»½)', targetCalories: 1750, workout: 'æ•£æ­© ã¾ãŸã¯ ã‚¹ãƒˆãƒ¬ãƒƒãƒ', workoutDetail: 'æœã‚¤ãƒã¾ãŸã¯å¤•æ–¹ã«20åˆ†ã®æ—©æ­©ã', sleepAdvice: 'ã‚¢ãƒ­ãƒãªã©ã§ãƒªãƒ©ãƒƒã‚¯ã‚¹ã€‚', dietDetail: { breakfast: 'åµã¨ãƒ–ãƒ­ãƒƒã‚³ãƒªãƒ¼', lunch: 'ã‚³ãƒ³ãƒ“ãƒ‹ãªã‚‰ã‚µãƒ©ãƒ€ãƒã‚­ãƒ³', dinner: 'ç™½èº«é­š', focus: 'é–“é£Ÿã«æ³¨æ„' }, color: 'bg-blue-100 border-blue-500 text-blue-800' },
            5: { day: 'é‡‘æ›œæ—¥', type: 'gym', title: 'ã‚¸ãƒ  (ç­‹ãƒˆãƒ¬B: èƒŒä¸­ãƒ»è…¹)', targetCalories: 1950, workout: 'èƒŒä¸­ãƒ»è…¹ç­‹ãƒ¡ã‚¤ãƒ³ï¼‹æœ‰é…¸ç´ ', workoutDetail: 'ãƒ©ãƒƒãƒˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã€ã‚¯ãƒ©ãƒ³ãƒ', sleepAdvice: 'å¤œæ›´ã‹ã—æ³¨æ„ã€‚', dietDetail: { breakfast: 'ã—ã£ã‹ã‚Šé£Ÿã¹ã‚‹', lunch: 'ãƒ‘ã‚¹ã‚¿ç­‰ã¯é¿ã‘ã‚‹', dinner: 'å±…é…’å±‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¢¨ï¼ˆãƒ˜ãƒ«ã‚·ãƒ¼ã«ï¼‰', focus: 'ãŠé…’ã¯è’¸ç•™é…’' }, color: 'bg-red-100 border-red-500 text-red-800' },
            6: { day: 'åœŸæ›œæ—¥', type: 'cardio', title: 'æœ‰é…¸ç´ å¼·åŒ– (ãƒ©ãƒ³/HIIT)', targetCalories: 1850, workout: 'ãƒ©ãƒ³ãƒ‹ãƒ³ã‚° ã¾ãŸã¯ HIIT', workoutDetail: 'è„‚è‚ªç‡ƒç„¼ãƒ‡ãƒ¼ã€‚ãƒ©ãƒ³30åˆ† or HIIT 4åˆ†', sleepAdvice: 'é‹å‹•ã®ç–²ã‚Œã§æ·±ãçœ ã‚‹ã€‚', dietDetail: { breakfast: 'ãƒãƒŠãƒŠï¼‹ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³', lunch: 'ç‚­æ°´åŒ–ç‰©OK', dinner: 'ãã®ã“ãƒ»æµ·è—»', focus: 'æ°´åˆ†ã‚’ãŸã£ã·ã‚Š' }, color: 'bg-orange-100 border-orange-500 text-orange-800' }
        };

        const INITIAL_GOAL = { weight: 65.0, bfp: 15.0, startWeight: 84.6, startBfp: 20.4 };

        // ç°¡æ˜“ã‚°ãƒ©ãƒ•ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
        const SimpleChart = ({ data, dataKey, color, label, unit, domain }) => {
            if (!data || data.length < 2) {
                return <div className="h-32 bg-slate-50 rounded-lg flex items-center justify-center border border-slate-100 text-slate-400 text-sm">ãƒ‡ãƒ¼ã‚¿ä¸è¶³</div>;
            }
            const values = data.map(d => d[dataKey]);
            const min = Math.min(...values, domain[0]);
            const max = Math.max(...values, domain[1]);
            const range = max - min || 1;
            const points = data.map((d, i) => {
                const x = (i / (data.length - 1)) * 100;
                const y = 100 - ((d[dataKey] - min) / range) * 100;
                return `${x},${y}`;
            }).join(' ');

            return (
                <div className="mb-4">
                    <div className="flex justify-between text-xs text-slate-500 mb-1 font-medium">
                        <span>{label}æ¨ç§»</span>
                        <span>Current: {values[values.length - 1]}{unit}</span>
                    </div>
                    <div className="h-24 w-full bg-white border border-slate-100 rounded-lg relative overflow-hidden p-2">
                        <svg viewBox="0 0 100 100" preserveAspectRatio="none" className="w-full h-full overflow-visible">
                            <line x1="0" y1="0" x2="100" y2="0" stroke="#f1f5f9" strokeWidth="1" />
                            <line x1="0" y1="50" x2="100" y2="50" stroke="#f1f5f9" strokeWidth="1" />
                            <line x1="0" y1="100" x2="100" y2="100" stroke="#f1f5f9" strokeWidth="1" />
                            <polyline fill="none" stroke={color} strokeWidth="2" points={points} vectorEffect="non-scaling-stroke" />
                            {data.map((d, i) => {
                                const x = (i / (data.length - 1)) * 100;
                                const y = 100 - ((d[dataKey] - min) / range) * 100;
                                return <circle key={i} cx={x} cy={y} r="1.5" fill={color} className="opacity-80" />;
                            })}
                        </svg>
                    </div>
                </div>
            );
        };

        // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
        function DietPartnerApp() {
            const [user, setUser] = useState(null);
            const [today, setToday] = useState(new Date());
            const [loading, setLoading] = useState(true);
            const [syncError, setSyncError] = useState(false);

            // ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒ†ãƒ¼ãƒˆ
            const [profile, setProfile] = useState({ weight: 84.6, bfp: 20.4, apiKey: "" });
            const [history, setHistory] = useState([
                { date: new Date(Date.now() - 86400000 * 2).toISOString(), weight: 85.0, bfp: 20.8 },
                { date: new Date(Date.now() - 86400000).toISOString(), weight: 84.8, bfp: 20.5 },
                { date: new Date().toISOString(), weight: 84.6, bfp: 20.4 }
            ]);
            const [dailyData, setDailyData] = useState({
                date: new Date().toISOString(),
                sleepHours: 6,
                feeling: 'normal',
                isCheckedIn: false,
                tasks: { meal: false, workout: false, sleep: false },
                isFinished: false,
                dailyFeedback: null,
                dailyImage: null // ç”»åƒã¯ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¡ãƒ¢ãƒªã®ã¿ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰ã§æ¶ˆãˆã¾ã™ï¼‰
            });
            const [mealLogs, setMealLogs] = useState({
                breakfast: { image: null, result: null, skipped: false },
                lunch: { image: null, result: null, skipped: false },
                dinner: { image: null, result: null, skipped: false }
            });
            const [aiPlan, setAiPlan] = useState(null);

            const [showSettings, setShowSettings] = useState(false);
            const [tempApiKey, setTempApiKey] = useState("");
            const [activeMeal, setActiveMeal] = useState('breakfast');
            const [analyzing, setAnalyzing] = useState(false);
            const [finishing, setFinishing] = useState(false);
            const [isPlanLoading, setIsPlanLoading] = useState(false);
            const fileInputRef = useRef(null);

            // ä»Šæ—¥ã®æ—¥ä»˜ID (YYYY-MM-DD)
            const todayDocId = useMemo(() => {
                const d = new Date();
                return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            }, [today]);

            // ãƒ—ãƒ©ãƒ³é¸æŠãƒ­ã‚¸ãƒƒã‚¯
            const plan = useMemo(() => {
                if (aiPlan) return aiPlan;
                return WEEKLY_PLAN_BASE[today.getDay()];
            }, [today, aiPlan]);

            // èªè¨¼ã¨åˆæœŸåŒ–
            useEffect(() => {
                const initAuth = async () => {
                    const { auth, initialAuthToken, signInWithCustomToken, signInAnonymously } = window;
                    if (!auth) {
                        setSyncError(true);
                        setLoading(false);
                        return;
                    }
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Auth failed", error);
                        setSyncError(true);
                        setLoading(false);
                    }
                };
                initAuth();

                if (window.auth) {
                    const unsubscribe = onAuthStateChanged(window.auth, (currentUser) => {
                        setUser(currentUser);
                        if (!currentUser) setLoading(false);
                    });
                    return () => unsubscribe();
                } else {
                    setLoading(false);
                }
            }, []);

            // Firestore åŒæœŸ
            useEffect(() => {
                if (!user) return;
                const { db, appId } = window;
                const userDocRef = (col) => doc(db, 'artifacts', appId, 'users', user.uid, 'diet_data', col);

                // Profile
                const unsubProfile = onSnapshot(userDocRef('profile'), (docSnap) => {
                    if (docSnap.exists()) {
                        setProfile(prev => ({ ...prev, ...docSnap.data() }));
                    }
                }, (err) => { console.error(err); setSyncError(true); });

                // History
                const unsubHistory = onSnapshot(userDocRef('history'), (docSnap) => {
                    if (docSnap.exists()) {
                        setHistory(docSnap.data().records || []);
                    }
                });

                // Daily Data
                const unsubDaily = onSnapshot(userDocRef(todayDocId), (docSnap) => {
                    setLoading(false);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setDailyData(prev => ({ ...prev, ...data.checkIn })); // ç”»åƒã¯DBã«ãªã„ã®ã§nullã«ãªã‚‹
                        if (data.mealLogs) {
                            setMealLogs(prev => {
                                const newLogs = {};
                                Object.keys(data.mealLogs).forEach(key => {
                                    // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¡ãƒ¢ãƒªã«ç”»åƒãŒã‚ã‚‹å ´åˆã¯ç¶­æŒã‚’è©¦ã¿ã‚‹ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨æ¶ˆãˆã‚‹ï¼‰
                                    newLogs[key] = { ...data.mealLogs[key], image: prev[key]?.image || null };
                                });
                                return newLogs;
                            });
                        }
                        if (data.aiPlan) setAiPlan(data.aiPlan);
                    }
                });

                return () => { unsubProfile(); unsubHistory(); unsubDaily(); };
            }, [user, todayDocId]);

            // ä¿å­˜å‡¦ç†ãƒ©ãƒƒãƒ‘ãƒ¼
            const saveDailyData = async (newCheckIn, newMealLogs, newAiPlan) => {
                if (!user) return;
                const { db, appId } = window;
                const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'diet_data', todayDocId);
                
                // ç”»åƒãƒ‡ãƒ¼ã‚¿(Base64)ã¯å®¹é‡åˆ¶é™ã®ãŸã‚DBä¿å­˜ã‹ã‚‰é™¤å¤–
                const cleanCheckIn = { ...newCheckIn, dailyImage: null };
                const cleanMealLogs = {};
                Object.keys(newMealLogs || mealLogs).forEach(key => {
                    const log = newMealLogs?.[key] || mealLogs[key];
                    cleanMealLogs[key] = { ...log, image: null };
                });

                await setDoc(docRef, {
                    checkIn: cleanCheckIn,
                    mealLogs: cleanMealLogs,
                    aiPlan: newAiPlan || aiPlan,
                    updatedAt: new Date().toISOString()
                }, { merge: true });
            };

            const saveProfile = async (newProfile) => {
                if (!user) return;
                const { db, appId } = window;
                const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'diet_data', 'profile');
                await setDoc(docRef, newProfile, { merge: true });
            };

            const saveHistory = async (newHistory) => {
                if (!user) return;
                const { db, appId } = window;
                const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'diet_data', 'history');
                await setDoc(docRef, { records: newHistory }, { merge: true });
            };

            // ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
            const handleSaveApiKey = () => {
                const newProfile = { ...profile, apiKey: tempApiKey };
                setProfile(newProfile);
                saveProfile(newProfile);
                setShowSettings(false);
                alert("APIã‚­ãƒ¼ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã—ã¾ã—ãŸï¼");
            };

            const openSettings = () => {
                setTempApiKey(profile.apiKey || "");
                setShowSettings(true);
            };

            const handleStatusChange = (e) => {
                const { name, value } = e.target;
                setProfile(prev => ({ ...prev, [name]: parseFloat(value) }));
            };

            // AIãƒ—ãƒ©ãƒ³ç”Ÿæˆ
            const generateDailyPlan = async (status, sleep) => {
                if (!profile.apiKey) return;
                setIsPlanLoading(true);
                const dayOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][today.getDay()];
                const recentHistory = history.slice(-3).map(h => `- ${new Date(h.date).toLocaleDateString()}: ${h.weight}kg`).join('\n');
                const prompt = `ãƒ€ã‚¤ã‚¨ãƒƒãƒˆã‚¤ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ã¨ã—ã¦ã€ä»Šæ—¥ã®æœ€é©ãƒ—ãƒ©ãƒ³ã‚’JSONã§ä½œæˆã€‚ç›®æ¨™65kg/15%ã€‚ç¾åœ¨${status.weight}kgã€‚${dayOfWeek}, ç¡çœ ${sleep}hã€‚å±¥æ­´:${recentHistory}ã€‚ç¡çœ ä¸è¶³æ™‚ã¯ä¼‘æ¯å„ªå…ˆã€‚JSON:{ "day": "${dayOfWeek}", "title": "ãƒ†ãƒ¼ãƒ", "type": "rest/home/gym/cardio/adjustment", "targetCalories": 1800, "workout": "æŒ‡ç¤º", "workoutDetail": "è©³ç´°", "sleepAdvice": "ç¡çœ ", "dietDetail": {"breakfast":"", "lunch":"", "dinner":"", "focus":""}, "color": "bg-indigo-100 border-indigo-500 text-indigo-800" }`;
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${profile.apiKey}`;
                try {
                    const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                    const data = await res.json();
                    if(data.candidates) {
                        const plan = JSON.parse(data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim());
                        setAiPlan(plan);
                        saveDailyData(dailyData, mealLogs, plan);
                    }
                } catch(e) { console.error(e); }
                setIsPlanLoading(false);
            };

            const handleCheckInSubmit = async (e) => {
                e.preventDefault();
                const newEntry = { date: new Date().toISOString(), weight: profile.weight, bfp: profile.bfp };
                const newHistory = [...history];
                const todayStr = new Date().toDateString();
                const existingIndex = newHistory.findIndex(h => new Date(h.date).toDateString() === todayStr);
                if (existingIndex >= 0) newHistory[existingIndex] = newEntry; else newHistory.push(newEntry);
                
                setHistory(newHistory);
                saveHistory(newHistory);
                saveProfile(profile);

                const newCheckIn = { ...dailyData, isCheckedIn: true, date: new Date().toISOString(), isFinished: false, dailyFeedback: null, dailyImage: null };
                setDailyData(newCheckIn);
                saveDailyData(newCheckIn, mealLogs, aiPlan);

                if (profile.apiKey) await generateDailyPlan(profile, dailyData.sleepHours);
            };

            const toggleTask = (taskName) => {
                if (dailyData.isFinished) return;
                const newTasks = { ...dailyData.tasks, [taskName]: !dailyData.tasks[taskName] };
                const newCheckIn = { ...dailyData, tasks: newTasks };
                setDailyData(newCheckIn);
                saveDailyData(newCheckIn, mealLogs, aiPlan);
            };

            // é£Ÿäº‹ãƒ»ç”»åƒé–¢é€£
            const handleImageUpload = (event) => {
                if (dailyData.isFinished) return;
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        // ãƒ­ãƒ¼ã‚«ãƒ«è¡¨ç¤ºç”¨ã«å³æ™‚åæ˜ 
                        setMealLogs(prev => ({ ...prev, [activeMeal]: { ...prev[activeMeal], image: reader.result } }));
                        analyzeImage(reader.result, activeMeal);
                    };
                    reader.readAsDataURL(file);
                }
                event.target.value = '';
            };

            const analyzeImage = async (base64Image, mealType) => {
                if (!profile.apiKey) { alert("APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™"); openSettings(); return; }
                setAnalyzing(true);
                const base64Data = base64Image.split(',')[1];
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${profile.apiKey}`;
                const payload = { contents: [{ parts: [{ text: "æ–™ç†åˆ†æ: ã‚«ãƒ­ãƒªãƒ¼(kcal), PFC(g), ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’JSON(name, calories, protein, fat, carbs, advice)ã§ã€‚" }, { inlineData: { mimeType: "image/jpeg", data: base64Data } }] }], generationConfig: { responseMimeType: "application/json" } };
                try {
                    const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const data = await res.json();
                    if(data.candidates) {
                        const result = JSON.parse(data.candidates[0].content.parts[0].text);
                        const newMealLogs = { ...mealLogs, [mealType]: { image: base64Image, result: result, skipped: false } };
                        setMealLogs(newMealLogs);
                        saveDailyData(dailyData, newMealLogs, aiPlan);
                    }
                } catch(e) { alert("è§£æã‚¨ãƒ©ãƒ¼"); }
                setAnalyzing(false);
            };

            const handleSkipMeal = (type) => { 
                if(window.confirm('æ¬ é£Ÿã«ã—ã¾ã™ã‹ï¼Ÿ')) {
                    const newLogs = { ...mealLogs, [type]: { image: null, result: null, skipped: true } };
                    setMealLogs(newLogs);
                    saveDailyData(dailyData, newLogs, aiPlan);
                }
            };
            const handleResetMeal = (type) => {
                const newLogs = { ...mealLogs, [type]: { image: null, result: null, skipped: false } };
                setMealLogs(newLogs);
                saveDailyData(dailyData, newLogs, aiPlan);
            };

            const totalCalories = useMemo(() => Object.values(mealLogs).reduce((sum, meal) => sum + (meal.result?.calories || 0), 0), [mealLogs]);
            const caloriesProgress = useMemo(() => Math.min(100, (totalCalories / plan.targetCalories) * 100), [totalCalories, plan]);

            const handleFinishDay = async () => {
                if (!window.confirm("1æ—¥ã®è¨˜éŒ²ã‚’ç¢ºå®šã—ã¾ã™ã‹ï¼Ÿ")) return;
                if (!profile.apiKey) { alert("APIã‚­ãƒ¼ãŒãªã„ãŸã‚è¨˜éŒ²ã®ã¿ä¿å­˜ã—ã¾ã™ã€‚"); saveDailyData({ ...dailyData, isFinished: true, dailyFeedback: "è¨˜éŒ²å®Œäº†" }, mealLogs, aiPlan); return; }
                
                setFinishing(true);
                const textPrompt = `ãƒ€ã‚¤ã‚¨ãƒƒãƒˆã‚³ãƒ¼ãƒã¨ã—ã¦ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯(100æ–‡å­—)ã€‚ç›®æ¨™65kg, ç¾åœ¨${profile.weight}kg, æ‘‚å–${totalCalories}/${plan.targetCalories}kcal, é”æˆ:é£Ÿ${dailyData.tasks.meal?1:0}/é‹${dailyData.tasks.workout?1:0}/ç¡${dailyData.tasks.sleep?1:0}`;
                const textUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${profile.apiKey}`;
                // Imagen 4 (Nano Banana Pro)
                const imageUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${profile.apiKey}`;
                
                let feedback = "ãŠç–²ã‚Œæ§˜ï¼";
                let image = null;
                let errorMessage = "";
                
                try {
                    // Text Gen
                    const tRes = await fetch(textUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: textPrompt }] }] }) });
                    const tData = await tRes.json();
                    if(tData.candidates) feedback = tData.candidates[0].content.parts[0].text;

                    // Image Gen (Imagen 4)
                    const feeling = dailyData.tasks.workout ? "energetic" : "relaxing";
                    const iRes = await fetch(imageUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ instances: [{ prompt: `Anime style fitness motivation poster, Theme: ${feeling}, fit person thumbs up` }], parameters: { sampleCount: 1 } }) });
                    const iData = await iRes.json();
                    
                    if (iData.error) {
                        errorMessage = `ç”»åƒç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${iData.error.message}`;
                    } else if (iData.predictions?.[0]?.bytesBase64Encoded) {
                        image = `data:image/png;base64,${iData.predictions[0].bytesBase64Encoded}`;
                    } else {
                        errorMessage = "ç”»åƒç”Ÿæˆå¤±æ•—";
                    }
                } catch(e) { console.error(e); errorMessage = "é€šä¿¡ã‚¨ãƒ©ãƒ¼"; }

                if (errorMessage) feedback += `\n(â€»${errorMessage})`;

                const newCheckIn = { ...dailyData, isFinished: true, dailyFeedback: feedback, dailyImage: image };
                setDailyData(newCheckIn);
                saveDailyData(newCheckIn, mealLogs, aiPlan);
                setFinishing(false);
                setTimeout(() => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }), 100);
            };

            const handleDailyReset = () => {
                if(window.confirm('ä»Šæ—¥ã®è¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                    const resetCheckIn = { date: new Date().toISOString(), sleepHours: 6, feeling: 'normal', isCheckedIn: false, tasks: { meal: false, workout: false, sleep: false }, isFinished: false, dailyFeedback: null, dailyImage: null };
                    const resetLogs = { breakfast: { image: null, result: null, skipped: false }, lunch: { image: null, result: null, skipped: false }, dinner: { image: null, result: null, skipped: false } };
                    setDailyData(resetCheckIn);
                    setMealLogs(resetLogs);
                    setAiPlan(null);
                    saveDailyData(resetCheckIn, resetLogs, null);
                }
            };

            if (loading) return <div className="min-h-screen flex items-center justify-center text-slate-500"><Loader2 className="w-10 h-10 animate-spin" /></div>;

            return (
                <div className="min-h-screen bg-slate-50 text-slate-800 font-sans pb-24">
                    <header className="bg-slate-900 text-white p-6 rounded-b-3xl shadow-lg relative overflow-hidden">
                        <div className="absolute top-0 right-0 w-32 h-32 bg-emerald-500 rounded-full blur-3xl opacity-20 -mr-10 -mt-10"></div>
                        <div className="flex justify-between items-center mb-6 relative z-10">
                            <div><h1 className="text-xl font-bold flex items-center gap-2"><Activity className="w-5 h-5 text-emerald-400" /> Diet Partner {syncError ? <CloudOff className="w-4 h-4 text-red-400" /> : <Cloud className="w-4 h-4 text-emerald-400" />}</h1><p className="text-slate-400 text-xs mt-1">Goal: 65kg / 15%</p></div>
                            <div className="flex items-center gap-3"><div className="text-right"><p className="text-xs text-slate-400">{today.toLocaleDateString()}</p><p className="font-bold text-lg">{plan.day}</p></div><button onClick={openSettings} className="bg-white/10 hover:bg-white/20 p-2 rounded-full"><Settings className="w-5 h-5 text-slate-200" /></button></div>
                        </div>
                        {dailyData.isCheckedIn && (
                            <div className="space-y-4 relative z-10">
                                <div className="flex justify-between items-center">
                                    <div className="bg-slate-800/50 p-3 rounded-lg w-[48%] backdrop-blur-sm"><p className="text-xs text-slate-400">ä½“é‡</p><div className="flex items-baseline gap-1"><span className="text-2xl font-bold">{profile.weight}</span><span className="text-xs">kg</span></div><p className="text-xs text-emerald-400 flex items-center gap-1"><TrendingDown className="w-3 h-3" />ã‚ã¨ {(profile.weight - INITIAL_GOAL.weight).toFixed(1)}kg</p></div>
                                    <div className="bg-slate-800/50 p-3 rounded-lg w-[48%] backdrop-blur-sm"><p className="text-xs text-slate-400">ä½“è„‚è‚ªç‡</p><div className="flex items-baseline gap-1"><span className="text-2xl font-bold">{profile.bfp}</span><span className="text-xs">%</span></div><p className="text-xs text-emerald-400 flex items-center gap-1"><TrendingDown className="w-3 h-3" />ã‚ã¨ {(profile.bfp - INITIAL_GOAL.bfp).toFixed(1)}%</p></div>
                                </div>
                                <div className="bg-white/5 p-3 rounded-xl border border-white/10"><SimpleChart data={history.slice(-14)} dataKey="weight" color="#34d399" label="Weight" unit="kg" domain={[INITIAL_GOAL.weight, INITIAL_GOAL.startWeight]} /></div>
                            </div>
                        )}
                    </header>

                    <main className="max-w-md mx-auto px-4 -mt-4 relative z-20">
                        {!dailyData.isCheckedIn ? (
                            <div className="bg-white rounded-xl shadow-xl p-6 mb-6 border border-slate-100">
                                <h2 className="text-lg font-bold mb-4 flex items-center gap-2 text-slate-700"><Scale className="w-5 h-5 text-blue-500" /> ãƒ¢ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ»ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</h2>
                                <form onSubmit={handleCheckInSubmit} className="space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="block text-xs font-bold text-slate-500 mb-1">ä½“é‡ (kg)</label><input type="number" step="0.1" name="weight" value={profile.weight} onChange={handleStatusChange} className="w-full p-3 border border-slate-200 rounded-lg text-xl font-bold text-slate-800 focus:ring-2 focus:ring-blue-500 outline-none" required /></div>
                                        <div><label className="block text-xs font-bold text-slate-500 mb-1">ä½“è„‚è‚ªç‡ (%)</label><input type="number" step="0.1" name="bfp" value={profile.bfp} onChange={handleStatusChange} className="w-full p-3 border border-slate-200 rounded-lg text-xl font-bold text-slate-800 focus:ring-2 focus:ring-blue-500 outline-none" required /></div>
                                    </div>
                                    <div><label className="block text-xs font-bold text-slate-500 mb-1">æ˜¨æ™©ã®ç¡çœ  (æ™‚é–“)</label><input type="number" step="0.5" value={dailyData.sleepHours} onChange={(e) => setDailyData({...dailyData, sleepHours: parseFloat(e.target.value)})} className="w-full p-3 border border-slate-200 rounded-lg text-xl font-bold text-slate-800 focus:ring-2 focus:ring-blue-500 outline-none" required /></div>
                                    <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-md flex items-center justify-center gap-2">è¨˜éŒ²ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆ <ChevronRight className="w-5 h-5" /></button>
                                </form>
                            </div>
                        ) : (
                            <div className="space-y-6 pt-4">
                                {dailyData.sleepHours < 6.5 && <div className="bg-amber-50 border-l-4 border-amber-500 p-4 rounded-r-lg shadow-sm flex items-start gap-3"><AlertCircle className="w-6 h-6 text-amber-500 flex-shrink-0 mt-1" /><div><h3 className="font-bold text-amber-800 text-sm">ç¡çœ ä¸è¶³ã‚¢ãƒ©ãƒ¼ãƒˆ</h3><p className="text-xs text-amber-700 mt-1">ç¡çœ {dailyData.sleepHours}æ™‚é–“ã€‚ã‚«ãƒ•ã‚§ã‚¤ãƒ³ã¯14æ™‚ã¾ã§ã€ä»®çœ æ¨å¥¨ã€‚</p></div></div>}

                                <section className={`rounded-xl shadow-lg border-2 overflow-hidden ${plan.color.replace('text-', 'border-').replace('bg-', 'bg-white ')}`}>
                                    <div className={`p-4 ${plan.color} flex justify-between items-center`}><h2 className="font-bold text-lg flex items-center gap-2"><Calendar className="w-5 h-5" /> {isPlanLoading ? "æœ€é©åŒ–ä¸­..." : "ä»Šæ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³"}</h2><span className="text-xs font-bold px-2 py-1 bg-white/60 rounded text-slate-800 uppercase tracking-wider">{plan.type}</span></div>
                                    <div className="p-5 bg-white relative">
                                        {isPlanLoading && <div className="absolute inset-0 bg-white/90 z-10 flex flex-col items-center justify-center text-slate-500"><Loader2 className="w-10 h-10 animate-spin text-blue-500 mb-2" /><p className="text-sm font-bold animate-pulse">AIãŒãƒ—ãƒ©ãƒ³ç”Ÿæˆä¸­...</p></div>}
                                        <h3 className="text-2xl font-bold text-slate-800 mb-3 flex items-center gap-2">{plan.title} {aiPlan && <Sparkles className="w-5 h-5 text-yellow-500" />}</h3>
                                        <div className="space-y-4">
                                            <div className="bg-slate-50 p-4 rounded-lg border border-slate-100"><div className="flex items-center gap-2 mb-2"><Activity className="w-4 h-4 text-blue-500" /><p className="text-sm font-bold text-slate-700">é‹å‹•æŒ‡ç¤º</p></div><p className="text-slate-700 font-bold mb-1">{plan.workout}</p><p className="text-xs text-slate-500 border-t border-slate-200 pt-2 mt-2">{plan.workoutDetail}</p></div>
                                            <div className="bg-slate-50 p-4 rounded-lg border border-slate-100">
                                                <div className="flex items-center justify-between mb-2"><div className="flex items-center gap-2"><Utensils className="w-4 h-4 text-emerald-500" /><p className="text-sm font-bold text-slate-700">é£Ÿäº‹ã‚¬ã‚¤ãƒ‰</p></div><div className="flex items-center gap-1 text-xs font-bold bg-white px-2 py-1 rounded border border-slate-200 text-emerald-600"><Flame className="w-3 h-3 fill-emerald-600" /> ç›®æ¨™: {plan.targetCalories} kcal</div></div>
                                                <ul className="text-xs text-slate-600 space-y-2 mb-3"><li><span className="font-bold text-emerald-600">æœ:</span> {plan.dietDetail.breakfast}</li><li><span className="font-bold text-emerald-600">æ˜¼:</span> {plan.dietDetail.lunch}</li><li><span className="font-bold text-emerald-600">å¤œ:</span> {plan.dietDetail.dinner}</li></ul>
                                                <div className="bg-emerald-50 p-2 rounded text-xs text-emerald-800 font-bold border border-emerald-100">POINT: {plan.dietDetail.focus}</div>
                                            </div>
                                        </div>
                                    </div>
                                </section>

                                <section className={`bg-gradient-to-r from-emerald-500 to-teal-600 rounded-xl shadow-lg p-5 text-white transition-opacity ${dailyData.isFinished ? 'opacity-75 pointer-events-none grayscale-[0.5]' : ''}`}>
                                    <div className="flex justify-between items-center mb-4">
                                        <div><h3 className="font-bold flex items-center gap-2"><Camera className="w-5 h-5" /> é£Ÿäº‹è¨˜éŒ² & AIåˆ†æ</h3><div className="flex items-baseline gap-2 mt-1"><p className="text-xs text-emerald-100 opacity-90">Total: <span className="text-lg font-bold">{totalCalories}</span> / {plan.targetCalories} kcal</p><span className={`text-xs font-bold px-1.5 rounded ${totalCalories > plan.targetCalories ? 'bg-red-500' : 'bg-emerald-700'}`}>{caloriesProgress.toFixed(0)}%</span></div><div className="w-full bg-black/20 h-1.5 rounded-full mt-1 max-w-[200px]"><div className={`h-full rounded-full transition-all duration-500 ${totalCalories > plan.targetCalories ? 'bg-red-400' : 'bg-white'}`} style={{ width: `${Math.min(100, (totalCalories / plan.targetCalories) * 100)}%` }}></div></div></div>
                                        <span className="text-xs bg-white/20 px-2 py-1 rounded text-white font-bold">Imagen 4</span>
                                    </div>
                                    <div className="flex p-1 bg-black/20 rounded-lg mb-4">{[{ id: 'breakfast', icon: Coffee, label: 'æœ' }, { id: 'lunch', icon: Sun, label: 'æ˜¼' }, { id: 'dinner', icon: Sunset, label: 'å¤œ' }].map((meal) => (<button key={meal.id} onClick={() => setActiveMeal(meal.id)} className={`flex-1 flex items-center justify-center gap-1 py-2 rounded-md text-sm font-bold transition-all ${activeMeal === meal.id ? 'bg-white text-teal-700 shadow-sm' : 'text-white/60 hover:bg-white/10'}`}><meal.icon className="w-3 h-3" /> {meal.label} {mealLogs[meal.id].result && <span className="ml-1 w-2 h-2 rounded-full bg-emerald-400"></span>}{mealLogs[meal.id].skipped && <span className="ml-1 w-2 h-2 rounded-full bg-slate-400"></span>}</button>))}</div>
                                    <div className="animate-in fade-in slide-in-from-right-2 duration-300" key={activeMeal}>
                                        {mealLogs[activeMeal].skipped ? (<div className="bg-black/20 rounded-lg p-6 flex flex-col items-center justify-center text-center"><Ban className="w-10 h-10 text-white/50 mb-2" /><p className="font-bold text-white">æ¬ é£Ÿ (Skipped)</p><button onClick={() => handleResetMeal(activeMeal)} className="mt-2 bg-white/20 text-xs px-4 py-2 rounded-full flex items-center gap-1"><Undo2 className="w-3 h-3" /> å–æ¶ˆ</button></div>) : !mealLogs[activeMeal].image ? (<div className="space-y-3"><button onClick={() => fileInputRef.current.click()} className="w-full bg-white/10 hover:bg-white/20 border-2 border-dashed border-white/30 rounded-lg p-6 flex flex-col items-center justify-center"><Camera className="w-8 h-8 mb-2 text-white/80" /><span className="text-sm font-bold">å†™çœŸã‚’æ’®ã‚‹</span><input type="file" ref={fileInputRef} accept="image/*" className="hidden" onChange={handleImageUpload} /></button><button onClick={() => handleSkipMeal(activeMeal)} className="w-full text-white/60 text-xs py-2 flex items-center justify-center gap-1"><Ban className="w-3 h-3" /> æ¬ é£Ÿè¨˜éŒ²</button></div>) : (<div className="space-y-4"><div className="relative rounded-lg overflow-hidden h-40 bg-black/20 flex items-center justify-center"><img src={mealLogs[activeMeal].image} alt="Food" className="h-full w-full object-cover opacity-90" />{analyzing ? <div className="absolute inset-0 bg-black/40 flex flex-col items-center justify-center"><Loader2 className="w-8 h-8 animate-spin text-white mb-2" /><span className="text-sm font-bold">AIåˆ†æä¸­...</span></div> : <button onClick={() => handleResetMeal(activeMeal)} className="absolute top-2 right-2 bg-black/50 p-1.5 rounded-full text-white hover:bg-black/70"><RefreshCw className="w-4 h-4" /></button>}</div>{mealLogs[activeMeal].result && (<div className="bg-white text-slate-800 rounded-lg p-4 shadow-sm"><h4 className="font-bold text-lg mb-1 border-b border-slate-100 pb-2 flex justify-between">{mealLogs[activeMeal].result.name}<span className="text-emerald-600 font-extrabold">{mealLogs[activeMeal].result.calories} kcal</span></h4><div className="grid grid-cols-3 gap-2 my-3 text-center"><div className="bg-red-50 p-2 rounded"><p className="text-[10px] text-red-500 font-bold">PRO</p><p className="font-bold text-red-700">{mealLogs[activeMeal].result.protein}g</p></div><div className="bg-yellow-50 p-2 rounded"><p className="text-[10px] text-yellow-500 font-bold">FAT</p><p className="font-bold text-yellow-700">{mealLogs[activeMeal].result.fat}g</p></div><div className="bg-blue-50 p-2 rounded"><p className="text-[10px] text-blue-500 font-bold">CARB</p><p className="font-bold text-blue-700">{mealLogs[activeMeal].result.carbs}g</p></div></div><div className="bg-slate-50 p-3 rounded text-sm text-slate-600 flex gap-2 items-start"><Sparkles className="w-4 h-4 text-yellow-500 flex-shrink-0 mt-0.5" /><p className="text-xs">{mealLogs[activeMeal].result.advice}</p></div></div>)}</div>)}
                                    </div>
                                </section>

                                <section className={`bg-white rounded-xl shadow-md p-5 border border-slate-100 transition-opacity ${dailyData.isFinished ? 'opacity-75 pointer-events-none' : ''}`}>
                                    <h3 className="font-bold text-lg text-slate-700 mb-4 flex items-center gap-2"><Trophy className="w-5 h-5 text-yellow-500" /> å®Œäº†å ±å‘Š</h3>
                                    <div className="space-y-3">
                                        <button onClick={() => toggleTask('meal')} className={`w-full p-4 rounded-lg border transition-all flex items-center gap-3 text-left ${dailyData.tasks.meal ? 'bg-emerald-50 border-emerald-500' : 'bg-white hover:border-emerald-300'}`}><div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${dailyData.tasks.meal ? 'bg-emerald-500 border-emerald-500' : 'border-slate-300'}`}>{dailyData.tasks.meal && <CheckCircle className="w-4 h-4 text-white" />}</div><div><span className={`block text-sm ${dailyData.tasks.meal ? 'text-emerald-900 font-bold' : 'text-slate-700 font-medium'}`}>é£Ÿäº‹ãƒ«ãƒ¼ãƒ«ã‚’å®ˆã£ãŸ</span></div></button>
                                        <button onClick={() => toggleTask('workout')} className={`w-full p-4 rounded-lg border transition-all flex items-center gap-3 text-left ${dailyData.tasks.workout ? 'bg-blue-50 border-blue-500' : 'bg-white hover:border-blue-300'}`}><div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${dailyData.tasks.workout ? 'bg-blue-500 border-blue-500' : 'border-slate-300'}`}>{dailyData.tasks.workout && <CheckCircle className="w-4 h-4 text-white" />}</div><div><span className={`block text-sm ${dailyData.tasks.workout ? 'text-blue-900 font-bold' : 'text-slate-700 font-medium'}`}>ãƒãƒ«ãƒé”æˆ: {plan.workout}</span></div></button>
                                        <button onClick={() => toggleTask('sleep')} className={`w-full p-4 rounded-lg border transition-all flex items-center gap-3 text-left ${dailyData.tasks.sleep ? 'bg-indigo-50 border-indigo-500' : 'bg-white hover:border-indigo-300'}`}>
                                            <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${dailyData.tasks.sleep ? 'bg-indigo-500 border-indigo-500' : 'border-slate-300'}`}>{dailyData.tasks.sleep && <CheckCircle className="w-4 h-4 text-white" />}</div><div><span className={`block text-sm ${dailyData.tasks.sleep ? 'text-indigo-900 font-bold' : 'text-slate-700 font-medium'}`}>å°±å¯æº–å‚™OK</span></div>
                                        </button>
                                    </div>
                                </section>

                                {!dailyData.isFinished ? (
                                    <div className="pt-2 pb-6"><button onClick={handleFinishDay} disabled={finishing} className={`w-full bg-slate-800 text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-2 transition-all active:scale-95 ${finishing ? 'opacity-70 cursor-wait' : 'hover:bg-slate-700'}`}>{finishing ? <><Loader2 className="w-5 h-5 animate-spin" /> ä½œæˆä¸­...</> : <><CheckCircle className="w-5 h-5" /> 1æ—¥ã‚’çµ‚äº†ã—ã¦å ±å‘Š</>}</button><p className="text-center text-xs text-slate-400 mt-2">â€»ç¢ºå®šã™ã‚‹ã¨ã‚³ãƒ¡ãƒ³ãƒˆã¨å¿œæ´ã‚¤ãƒ©ã‚¹ãƒˆãŒå±Šãã¾ã™</p></div>
                                ) : (
                                    <div className="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl shadow-xl p-6 text-white mb-6 animate-in zoom-in-95 duration-500">
                                        <div className="flex items-center gap-2 mb-4"><Award className="w-8 h-8 text-yellow-300" /><div><h3 className="font-bold text-xl">Good Job!</h3><p className="text-xs text-indigo-100 opacity-90">æ´»å‹•è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸ</p></div></div>
                                        <div className="bg-white/10 rounded-lg p-4 backdrop-blur-sm border border-white/20 relative mb-4"><div className="absolute -top-3 -left-2 bg-yellow-400 text-slate-900 text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm">INSTRUCTOR'S COMMENT</div><div className="flex gap-3"><div className="w-10 h-10 rounded-full bg-slate-200 border-2 border-white flex items-center justify-center flex-shrink-0 text-2xl overflow-hidden">ğŸ‘¨â€ğŸ«</div><p className="text-sm leading-relaxed font-medium">{dailyData.dailyFeedback}</p></div></div>
                                        {dailyData.dailyImage ? (<div className="rounded-lg overflow-hidden border-4 border-white/20 shadow-lg relative"><img src={dailyData.dailyImage} alt="Reward" className="w-full h-auto object-cover" /><div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-3"><p className="text-xs text-white font-bold flex items-center gap-1"><ImageIcon className="w-3 h-3" /> AI Generated Reward (Imagen 4)</p></div></div>) : (<div className="bg-white/5 rounded-lg h-32 flex flex-col items-center justify-center text-white/50 border border-dashed border-white/20"><ImageIcon className="w-8 h-8 mb-1 opacity-50" /><span className="text-xs">No image (ä¿å­˜ã•ã‚Œã¾ã›ã‚“)</span></div>)}
                                        <div className="mt-4 flex justify-between items-center text-xs text-indigo-100"><span>æ˜æ—¥ã‚‚ã“ã®èª¿å­ã§ï¼</span><div className="flex gap-1">{[1,2,3].map(i => <Star key={i} className="w-4 h-4 text-yellow-300 fill-yellow-300" />)}</div></div>
                                    </div>
                                )}

                                <div className="text-center pt-8 pb-4"><button onClick={handleDailyReset} className="text-xs text-slate-300 flex items-center justify-center gap-1 mx-auto hover:text-red-400 transition-colors"><RefreshCw className="w-3 h-3" /> ä»Šæ—¥ã®è¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆ</button></div>
                            </div>
                        )}
                    </main>
                    <footer className="fixed bottom-0 w-full bg-white/90 backdrop-blur border-t border-slate-200 p-3 text-center text-[10px] text-slate-400 z-50">Professional Diet Instructor System v3.2 (Cloud)</footer>

                    {showSettings && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
                                <div className="flex justify-between items-center mb-4"><h3 className="text-lg font-bold flex items-center gap-2"><Settings className="w-5 h-5 text-slate-500" /> è¨­å®š</h3><button onClick={() => setShowSettings(false)} className="text-slate-400 hover:text-slate-600"><X className="w-5 h-5" /></button></div>
                                <div className="space-y-4">
                                    <div><label className="block text-sm font-bold text-slate-600 mb-1">Google Gemini APIã‚­ãƒ¼</label><input type="password" value={tempApiKey} onChange={(e) => setTempApiKey(e.target.value)} className="w-full p-2 border rounded-lg text-sm" placeholder="AIzaSy..." /><p className="text-xs text-slate-400 mt-1">â€»è¨­å®šã¯ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã•ã‚Œã€ä»–ç«¯æœ«ã§ã‚‚æœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚</p></div>
                                    <button onClick={handleSaveApiKey} className="w-full bg-emerald-600 text-white font-bold py-2 rounded-lg">ä¿å­˜ã™ã‚‹</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<DietPartnerApp />);
    </script>
</body>
</html>
